<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfin Migrator</title>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,directorybrowser">
        <div data-role="content">
            <div class="content-primary">
                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #2a2a2a; border-radius: 4px; font-size: 0.85em; color: #aaa;">
                    <strong>Plugin Build:</strong> <span id="BuildDate">Loading...</span>
                </div>
                <form id="TemplateConfigForm">
                    <!-- Tab Navigation -->
                    <div class="inputContainer" style="margin-bottom:0.75rem;">
                        <div style="display:flex; gap:8px;">
                            <button is="emby-button" type="button" class="emby-button button-flat raised" id="TabExport">Export</button>
                            <button is="emby-button" type="button" class="emby-button button-flat" id="TabImport">Import</button>
                        </div>
                    </div>

                    <!-- Export Tab -->
                    <div id="ExportTab" style="display:block;">
                        <div class="fieldDescription">Jellyfin Export</div>

                        <!-- Export Users Section -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludeUsers" type="checkbox" is="emby-checkbox" />
                                <span>Export Users</span>
                            </label>
                            <div class="fieldDescription">Select which users to include.</div>
                        </div>
                        <div id="UsersList" class="inputContainer" style="background:#1b1b1b; color:#ddd; padding:10px; border-radius:4px;"></div>

                        <!-- Password Hashes -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludeUserPasswordHashes" type="checkbox" is="emby-checkbox" />
                                <span>Include Password Hashes (from DB)</span>
                            </label>
                            <div class="fieldDescription">Sensitive. Uses server database. Only for selected users.</div>
                        </div>

                        <!-- Export Libraries Section -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludeLibraries" type="checkbox" is="emby-checkbox" />
                                <span>Export Libraries</span>
                            </label>
                            <div class="fieldDescription">Select which libraries to include.</div>
                        </div>
                        <div id="LibrariesList" class="inputContainer" style="background:#1b1b1b; color:#ddd; padding:10px; border-radius:4px;"></div>

                        <!-- Permissions -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludePermissions" type="checkbox" is="emby-checkbox" />
                                <span>Export Permissions</span>
                            </label>
                            <div class="fieldDescription">Exports per-user library access for selected users/libraries.</div>
                        </div>

                        <!-- Watch History -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludeWatchHistory" type="checkbox" is="emby-checkbox" />
                                <span>Export Watch History</span>
                            </label>
                            <div class="fieldDescription">Filtered by selected users and libraries.</div>
                        </div>

                        <!-- Devices -->
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IncludeDevices" type="checkbox" is="emby-checkbox" />
                                <span>Export Devices</span>
                            </label>
                            <div class="fieldDescription">Filtered by selected users.</div>
                            <div class="fieldDescription" style="margin-top:4px; color:#e67e22; font-weight:600;">
                                Warning: Device export may include authentication bindings so clients remain signed in.
                                Treat the export as sensitive data (like API keys). Do not share or store on untrusted media.
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save Config</span>
                            </button>
                            <button id="RunExportNow" is="emby-button" type="button" class="emby-button raised button-submit block" style="margin-top: 0.5rem;">
                                <span id="RunButtonText">Save Config & Run Export</span>
                            </button>
                            <div id="DownloadExportContainer" style="display:none; margin-top:0.5rem;">
                                <button id="DownloadServerZipBtn" is="emby-button" type="button" class="emby-button raised">Download Export ZIP</button>
                            </div>
                            <div id="ExportRunStatus" style="margin-top:0.5rem; font-weight:600;"></div>
                            <div class="inputContainer" style="margin-top:0.5rem;">
                                <label class="inputLabel inputLabelUnfocused" id="LogHeader">Last Run Log</label>
                                <pre id="ExportLog" style="max-height:240px; overflow:auto; background:#111; color:#ddd; padding:8px; border-radius:4px;"></pre>
                                <div id="ExportMeta" class="fieldDescription"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Import Tab -->
                    <div id="ImportTab" style="display:none;">
                        <div class="fieldDescription">Jellyfin Import</div>

                        <!-- Import Directory (Hidden for now) -->
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ImportDirectory">Import Directory</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input id="ImportDirectory" name="ImportDirectory" type="text" is="emby-input" placeholder="e.g. C:/jellyfin-exports/20251006_195900" style="flex:1;" />
                                <button is="emby-button" type="button" class="raised emby-button" id="BrowseImportDir">Browse…</button>
                            </div>
                            <div class="fieldDescription">Import is a holding page in this build. Directory will be used once import is implemented.</div>
                        </div>

                        <!-- Import Holding Message -->
                        <div id="ImportHolding" style="display:block; margin-top:0.75rem; background:#1b1b1b; color:#ddd; padding:10px; border-radius:4px;">
                            <div style="font-weight:600; margin-bottom:6px;">Import (Holding Page)</div>
                            <div>Import functionality is not yet available in this build. You will be able to point to an export directory and apply it to this server.</div>
                        </div>

                        <!-- ZIP Upload Section -->
                        <div id="ImportZipSection" style="display:block; margin-top:0.75rem;">
                            <label class="inputLabel inputLabelUnfocused" for="ImportZipFile">Upload Export ZIP</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input id="ImportZipFile" name="ImportZipFile" type="file" accept=".zip,application/zip" style="flex:1;" />
                                <button is="emby-button" type="button" class="raised emby-button" id="UploadImportZip">Upload ZIP & Analyze</button>
                            </div>
                            <div class="fieldDescription">Select the ZIP created by the Export. The server will extract and validate it, then show the users and libraries found.</div>
                        </div>

                        <!-- Import Analysis Status -->
                        <div id="ImportAnalyzeStatus" style="display:none; margin-top:0.5rem; font-weight:600;">Analyzing...</div>
                        <div id="ImportBreakdown" style="display:none; margin-top:0.75rem; background:#1b1b1b; color:#ddd; padding:10px; border-radius:4px;"></div>

                        <!-- Import Action Buttons -->
                        <div id="ImportActionsContainer" style="display:none; margin-top:1rem;">
                            <button id="RunImportNow" is="emby-button" type="button" class="emby-button raised button-submit block">
                                <span id="RunImportButtonText">Run Library Import</span>
                            </button>
                            <div id="ImportRunStatus" style="margin-top:0.5rem; font-weight:600;"></div>
                            <div class="inputContainer" style="margin-top:0.5rem;">
                                <label class="inputLabel inputLabelUnfocused" id="ImportLogHeader">Import Log</label>
                                <pre id="ImportLog" style="max-height:240px; overflow:auto; background:#111; color:#ddd; padding:8px; border-radius:4px;"></pre>
                                <div id="ImportMeta" class="fieldDescription"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            // ===== JELLYFIN MIGRATOR CONFIGURATION PAGE =====
            // Minimal zip builder using fflate (embedded v0.8.2)
            /* eslint-disable */
            const fflate=(()=>{function h(e,t){return Object.setPrototypeOf(e,t),e}function p(e,t){e.push(t>>24&255,t>>16&255,t>>8&255,255&t)}function y(e,t){for(let r=0;r<4;r++)e.push(255&t),t>>=8}function w(e){let t=0;for(let r=0;r<e.length;r++)t=t>>>0+e[r]>>>0,t>>>0>=4294967296&&(t-=4294967296);return t>>>0}function C(e){let t=~e>>>0;return y([],t)}function S(e,t,r){let n=[];y(n,67324752),y(n,t),y(n,20),y(n,0),y(n,0),y(n,0),y(n,0),y(n,0),y(n,0),y(n,r.length),y(n,0),n.push(...e),n.push(...r);return n}function P(e,t,r,n,i){let a=[];y(a,33639248),y(a,t),y(a,20),y(a,0),y(a,0),y(a,0),y(a,0),y(a,0),y(a,0),y(a,r.length),y(a,0),y(a,0),y(a,0),y(a,0),y(a,n),y(a,0),a.push(...e);let s=i;return a.push(...s),a}function D(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].length;return t}function T(e){return new Blob([new Uint8Array(e)],{type:'application/zip'})}function B(e){let t=0;for(let r of e)t+=r.length;return t}return{zipSync:function(e){let t=[],r=[],n=[],i=0;for(let a of e){let s=new TextEncoder().encode(a.name),o=typeof a.data=='string'?new TextEncoder().encode(a.data):new Uint8Array(a.data),l=o.length,c=w(o),u=S(s,0,[],o);r.push(u);let f=P(s,0,[],l,[]);n.push(f),i+=u.length}let a=[];for(let s of r)a.push(...s);let o=D(n),l=a.length;for(let s of n)a.push(...s);y(a,101010256),y(a,0),y(a,0),y(a,r.length),y(a,r.length),y(a,o),y(a,l),y(a,0);return T(a)}}})();
            /* eslint-enable */

            const TemplateConfig = {
                pluginUniqueId: 'eb5d7894-8eef-4b36-aa6f-5d124e828ce1'
            };

            // ===== UTILITY FUNCTIONS =====
            function downloadServerZipFromConfig(cfg) {
                var b64 = (cfg && cfg.LastExportZipBase64) || '';
                if (!b64) { Dashboard.alert({ title: 'Export', message: 'ZIP not ready yet. Please wait a moment.' }); return; }
                try {
                    var byteChars = atob(b64);
                    var byteNumbers = new Array(byteChars.length);
                    for (var i = 0; i < byteChars.length; i++) { byteNumbers[i] = byteChars.charCodeAt(i); }
                    var byteArray = new Uint8Array(byteNumbers);
                    var blob = new Blob([byteArray], { type: 'application/zip' });
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    var ts = cfg.LastExportUtc ? new Date(cfg.LastExportUtc).toISOString().replace(/[:T]/g,'-').split('.')[0] : '';
                    a.download = ts ? ('jellyfin-export-' + ts + '.zip') : 'jellyfin-export.zip';
                    document.body.appendChild(a); a.click(); a.remove();
                } catch (e) { console.error('Failed to decode ZIP', e); Dashboard.alert({ title: 'Export', message: 'Failed to decode ZIP. See console.'}); }
            }

            function loadUsersAndLibraries(config) {
                var $users = document.querySelector('#UsersList');
                var $libs = document.querySelector('#LibrariesList');
                $users.innerHTML = '<div>Loading users…</div>';
                $libs.innerHTML = '<div>Loading libraries…</div>';

                var usersUrl = ApiClient.getUrl('Users');
                var libsUrl = ApiClient.getUrl('Library/VirtualFolders');

                Promise.all([
                    ApiClient.fetch({ url: usersUrl, method: 'GET' }).then(function (r) { return r.json(); }),
                    ApiClient.fetch({ url: libsUrl, method: 'GET' }).then(function (r) { return r.json(); })
                ]).then(function (results) {
                    var users = results[0] || [];
                    var libraries = results[1] || [];

                    // Users
                    var uHtml = users.map(function (u) {
                        var checked = (config.SelectedUserIds || []).indexOf(u.Id) !== -1 ? 'checked' : '';
                        return '<label class="emby-checkbox-label" style="display:block;">' +
                            '<input data-kind="user" type="checkbox" is="emby-checkbox" value="' + (u.Id || '') + '" data-username="' + (u.Name || '') + '" ' + checked + ' />' +
                            '<span>' + (u.Name || '') + '</span>' +
                        '</label>';
                    }).join('');
                    $users.innerHTML = '<div class="fieldDescription">Select users to include</div>' + uHtml;

                    // Libraries
                    var lHtml = libraries.map(function (l) {
                        var checked = (config.SelectedLibraryIds || []).indexOf(l.ItemId) !== -1 ? 'checked' : '';
                        var dataPaths = encodeURIComponent(JSON.stringify(l.Locations || []));
                        return '<label class="emby-checkbox-label" style="display:block;">' +
                            '<input data-kind="library" type="checkbox" is="emby-checkbox" value="' + (l.ItemId || '') + '" data-paths="' + dataPaths + '" ' + checked + ' />' +
                            '<span>' + (l.Name || '') + ' (' + (l.CollectionType || 'Mixed') + ')</span>' +
                        '</label>';
                    }).join('');
                    $libs.innerHTML = '<div class="fieldDescription">Select libraries to include</div>' + lHtml;
                }).catch(function (err) {
                    console.error('Failed to load users/libraries', err);
                    $users.innerHTML = '<div class="fieldDescription">Failed to load users</div>';
                    $libs.innerHTML = '<div class="fieldDescription">Failed to load libraries</div>';
                }).finally(function () {
                    Dashboard.hideLoadingMsg();
                });
            }

            function renderExportLog(config) {
                var $log = document.querySelector('#ExportLog');
                var $meta = document.querySelector('#ExportMeta');
                if (!$log || !$meta) { return; }
                var log = (config.LastExportLog || '').toString();
                $log.textContent = log.trim() ? log : '(no recent log)';
                var parts = [];
                if (config.LastExportUtc) { try { parts.push('Completed: ' + new Date(config.LastExportUtc).toLocaleString()); } catch(e) {} }
                if (config.LastExportPath) { parts.push('Path: ' + config.LastExportPath); }
                $meta.textContent = parts.join(' | ');
            }

            function esc(s){ return (s||'').toString().replace(/[&<>\"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'})[c]; }); }

            function applyBulkPathReplacement() {
                var findPrefix = document.getElementById('PathFindPrefix');
                var replacePrefix = document.getElementById('PathReplacePrefix');

                if (!findPrefix || !replacePrefix) return;

                var findVal = findPrefix.value;
                var replaceVal = replacePrefix.value;

                if (!findVal) {
                    Dashboard.alert({ title: 'Bulk Path Replacement', message: 'Please enter a path prefix to find.' });
                    return;
                }

                if (!replaceVal) {
                    Dashboard.alert({ title: 'Bulk Path Replacement', message: 'Please enter a replacement path prefix.' });
                    return;
                }

                // Normalize the find prefix to handle both slash types
                var findNormalized = findVal.replace(/\//g, '\\').replace(/\\+/g, '\\');
                var findForwardSlash = findVal.replace(/\\/g, '/').replace(/\/+/g, '/');

                // Detect target path convention from replacement pattern
                var targetIsWindows = replaceVal.indexOf('\\') !== -1 || replaceVal.match(/^[A-Za-z]:/);
                var targetSeparator = targetIsWindows ? '\\' : '/';

                // Get all path inputs
                var pathInputs = document.querySelectorAll('.import-lib-path');
                var updatedCount = 0;

                pathInputs.forEach(function(input) {
                    var currentPath = input.value;
                    var newPath = currentPath;

                    // Try matching with backslashes
                    if (newPath.replace(/\//g, '\\').indexOf(findNormalized) === 0) {
                        newPath = replaceVal + newPath.replace(/\//g, '\\').substring(findNormalized.length);
                    }
                    // Try matching with forward slashes
                    else if (newPath.replace(/\\/g, '/').indexOf(findForwardSlash) === 0) {
                        newPath = replaceVal + newPath.replace(/\\/g, '/').substring(findForwardSlash.length);
                    }

                    // Normalize separators in the result
                    if (targetIsWindows) {
                        newPath = newPath.replace(/\//g, '\\').replace(/\\+/g, '\\');
                    } else {
                        newPath = newPath.replace(/\\/g, '/').replace(/\/+/g, '/');
                    }

                    if (newPath !== currentPath) {
                        input.value = newPath;
                        updatedCount++;
                    }
                });

                if (updatedCount > 0) {
                    Dashboard.alert({
                        title: 'Bulk Path Replacement',
                        message: 'Updated ' + updatedCount + ' path(s) successfully. Path separators normalized to ' + (targetIsWindows ? 'Windows (\\)' : 'Linux (/)') + ' style.'
                    });
                } else {
                    Dashboard.alert({
                        title: 'Bulk Path Replacement',
                        message: 'No paths matched the find prefix "' + findVal + '".'
                    });
                }
            }

            function renderImportBreakdown(data){
                var breakdownEl = document.getElementById('ImportBreakdown');
                if (!breakdownEl) return;
                var users = (data && data.Users) || [];
                var libs = (data && data.Libraries) || [];
                var errs = (data && data.Errors) || [];
                var extracted = (data && data.ExtractedPath) || '';

                var html = '';

                if (extracted) {
                    html += '<div class="fieldDescription" style="margin-bottom:12px;">Extracted to: ' + esc(extracted) + '</div>';
                }

                if (errs.length){
                    html += '<div style="color:#e67e22; margin:12px 0; padding:8px; background:#2b1810; border-radius:4px;">'+
                            '<b>Warnings/Errors:</b><ul style="margin:4px 0 0 20px;">' +
                            errs.map(function(e){return '<li>'+esc(e)+'</li>';}).join('') +
                            '</ul></div>';
                }

                // Users Section
                html += '<div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1rem;">';
                html += '<label class="emby-checkbox-label">';
                html += '<input id="ImportIncludeUsers" type="checkbox" is="emby-checkbox" checked />';
                html += '<span>Import Users</span>';
                html += '</label>';
                html += '<div class="fieldDescription">Select which users to import.</div>';
                html += '</div>';
                html += '<div id="ImportUsersList" class="inputContainer">';
                html += '<div class="fieldDescription">Select users to import</div>';

                if (users.length){
                    users.forEach(function(user, idx){
                        var userId = esc(user.Id || '');
                        var username = esc(user.Username || 'Unnamed');
                        var isAdmin = user.IsAdministrator ? ' (Administrator)' : '';
                        var isDisabled = user.IsDisabled ? ' (Disabled)' : '';
                        var userLibs = (user.LibraryNames || []).join(', ') || 'All libraries';

                        html += '<label class="emby-checkbox-label" style="display:block;">';
                        html += '<input data-kind="import-user" type="checkbox" is="emby-checkbox" value="'+userId+'" data-username="'+esc(username)+'" checked />';
                        html += '<span>' + username + isAdmin + isDisabled + '</span>';
                        html += '</label>';
                    });
                } else {
                    html += '<div class="fieldDescription">No users found in export.</div>';
                }
                html += '</div>';

                // Libraries Section
                html += '<div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1rem;">';
                html += '<label class="emby-checkbox-label">';
                html += '<input id="ImportIncludeLibraries" type="checkbox" is="emby-checkbox" checked />';
                html += '<span>Import Libraries</span>';
                html += '</label>';
                html += '<div class="fieldDescription">Select which libraries to import.</div>';
                html += '</div>';

                // Path Replacement Tool
                if (libs.length && libs.some(function(l){ return (l.Locations || []).length > 0; })) {
                    html += '<div style="margin-bottom:1rem; padding:10px; background:#2a2a2a; border-radius:4px;">';
                    html += '<div style="font-weight:600; margin-bottom:6px;">Bulk Path Replacement</div>';
                    html += '<div class="fieldDescription" style="margin-bottom:8px;">Replace a common path prefix across all library paths. Useful for migrating between different systems.</div>';
                    html += '<div style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">';
                    html += '<div style="flex:1; min-width:200px;">';
                    html += '<label class="inputLabel inputLabelUnfocused" style="font-size:0.85em;">Find Path Prefix</label>';
                    html += '<input type="text" is="emby-input" id="PathFindPrefix" placeholder="e.g. F:\\Media\\" style="width:100%;" />';
                    html += '</div>';
                    html += '<div style="flex:1; min-width:200px;">';
                    html += '<label class="inputLabel inputLabelUnfocused" style="font-size:0.85em;">Replace With</label>';
                    html += '<input type="text" is="emby-input" id="PathReplacePrefix" placeholder="e.g. /media/" style="width:100%;" />';
                    html += '</div>';
                    html += '<button type="button" is="emby-button" class="raised emby-button" onclick="applyBulkPathReplacement()" style="margin-bottom:2px;">Apply to All Paths</button>';
                    html += '</div>';
                    html += '<div class="fieldDescription" style="margin-top:6px; font-size:0.8em; color:#999;">Note: Path separators will be auto-normalized based on the replacement pattern (/ for Linux/Unix, \\ for Windows).</div>';
                    html += '</div>';
                }

                html += '<div id="ImportLibrariesList" class="inputContainer">';
                html += '<div class="fieldDescription">Select libraries to import</div>';

                if (libs.length){
                    libs.forEach(function(lib, idx){
                        var libId = esc(lib.Id || '');
                        var libName = esc(lib.Name || 'Unnamed');
                        var libType = esc(lib.CollectionType || 'mixed');
                        var locations = (lib.Locations || []);

                        html += '<div style="margin-bottom:0.75rem;">';
                        html += '<label class="emby-checkbox-label" style="display:block;">';
                        html += '<input data-kind="import-library" type="checkbox" is="emby-checkbox" value="'+libId+'" data-name="'+esc(libName)+'" checked />';
                        html += '<span>' + libName + ' (' + libType + ')</span>';
                        html += '</label>';

                        if (locations.length) {
                            html += '<div style="margin-left:24px; margin-top:4px;">';
                            locations.forEach(function(loc, locIdx){
                                html += '<div style="margin-bottom:4px;">';
                                html += '<label class="inputLabel inputLabelUnfocused" style="font-size:0.85em;">Path ' + (locIdx + 1) + '</label>';
                                html += '<input type="text" is="emby-input" class="import-lib-path" data-lib-id="'+libId+'" data-path-idx="'+locIdx+'" value="'+esc(loc)+'" style="width:100%;" />';
                                html += '</div>';
                            });
                            html += '</div>';
                        }
                        html += '</div>';
                    });
                } else {
                    html += '<div class="fieldDescription">No libraries found in export.</div>';
                }
                html += '</div>';

                // Permissions Section
                html += '<div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1rem;">';
                html += '<label class="emby-checkbox-label">';
                html += '<input id="ImportIncludePermissions" type="checkbox" is="emby-checkbox" checked />';
                html += '<span>Import Permissions</span>';
                html += '</label>';
                html += '<div class="fieldDescription">Import per-user library access for selected users/libraries.</div>';
                html += '</div>';

                breakdownEl.innerHTML = html;
                breakdownEl.style.display = 'block';

                // Show import actions container
                var actionsEl = document.getElementById('ImportActionsContainer');
                if (actionsEl && (libs.length || users.length)) {
                    actionsEl.style.display = 'block';
                }
            }

            // ===== PAGE INITIALIZATION =====
            document.querySelector('#TemplateConfigPage').addEventListener('pageshow', function() {
                // Set build date (updated on each build)
                var buildDate = new Date().toISOString().replace('T', ' ').substring(0, 19);
                document.getElementById('BuildDate').textContent = buildDate + ' UTC (Page Load Time)';

                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                    document.querySelector('#IncludeUsers').checked = config.IncludeUsers === true;
                    document.querySelector('#IncludeUserPasswordHashes').checked = config.IncludeUserPasswordHashes === true;
                    document.querySelector('#IncludeLibraries').checked = config.IncludeLibraries === true;
                    document.querySelector('#IncludePermissions').checked = config.IncludePermissions === true;
                    document.querySelector('#IncludeWatchHistory').checked = config.IncludeWatchHistory === true;
                    document.querySelector('#IncludeDevices').checked = config.IncludeDevices === true;
                    loadUsersAndLibraries(config);
                    try { renderExportLog(config); } catch (e) {}
                });
            });

            // ===== FORM SUBMISSION =====
            document.querySelector('#TemplateConfigForm').addEventListener('submit', function(e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                    config.IncludeUsers = document.querySelector('#IncludeUsers').checked;
                    config.IncludeUserPasswordHashes = document.querySelector('#IncludeUserPasswordHashes').checked;
                    config.IncludeLibraries = document.querySelector('#IncludeLibraries').checked;
                    config.IncludePermissions = document.querySelector('#IncludePermissions').checked;
                    config.IncludeWatchHistory = document.querySelector('#IncludeWatchHistory').checked;
                    config.IncludeDevices = document.querySelector('#IncludeDevices').checked;

                    var selectedUserIds = [];
                    var selectedUsernames = [];
                    document.querySelectorAll('#UsersList input[type="checkbox"][data-kind="user"]:checked').forEach(function (el) {
                        selectedUserIds.push(el.value);
                        selectedUsernames.push(el.getAttribute('data-username'));
                    });
                    config.SelectedUserIds = selectedUserIds;
                    config.SelectedUsernames = selectedUsernames;

                    var selectedLibIds = [];
                    var selectedLibPaths = [];
                    document.querySelectorAll('#LibrariesList input[type="checkbox"][data-kind="library"]:checked').forEach(function (el) {
                        selectedLibIds.push(el.value);
                        try {
                            var paths = JSON.parse(decodeURIComponent(el.getAttribute('data-paths') || '[]'));
                            (paths || []).forEach(function (p) { selectedLibPaths.push(p); });
                        } catch {}
                    });
                    config.SelectedLibraryIds = selectedLibIds;
                    config.SelectedLibraryPaths = selectedLibPaths;

                    var modeSubmit = (function(){
                        var vt = document.getElementById('VerifyTab');
                        var it = document.getElementById('ImportTab');
                        if (vt && vt.style && vt.style.display !== 'none') return 'Verify';
                        if (it && it.style && it.style.display !== 'none') return 'Import';
                        return 'Export';
                    })();
                    config.Mode = modeSubmit;

                    ApiClient.updatePluginConfiguration(TemplateConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
                e.preventDefault();
                return false;
            });

            // ===== RUN EXPORT BUTTON =====
            document.querySelector('#RunExportNow').addEventListener('click', function () {
                Dashboard.showLoadingMsg();
                var $status = document.querySelector('#ExportRunStatus');
                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                    var mode = (function(){
                        var vt = document.getElementById('VerifyTab');
                        var it = document.getElementById('ImportTab');
                        if (vt && vt.style && vt.style.display !== 'none') return 'Verify';
                        if (it && it.style && it.style.display !== 'none') return 'Import';
                        return 'Export';
                    })();
                    config.Mode = mode;
                    config.IncludeUsers = document.querySelector('#IncludeUsers').checked;
                    config.IncludeUserPasswordHashes = document.querySelector('#IncludeUserPasswordHashes').checked;
                    config.IncludeLibraries = document.querySelector('#IncludeLibraries').checked;
                    config.IncludePermissions = document.querySelector('#IncludePermissions').checked;
                    config.IncludeWatchHistory = document.querySelector('#IncludeWatchHistory').checked;
                    config.IncludeDevices = document.querySelector('#IncludeDevices').checked;

                    var selectedUserIds = [];
                    var selectedUsernames = [];
                    document.querySelectorAll('#UsersList input[type="checkbox"][data-kind="user"]:checked').forEach(function (el) {
                        selectedUserIds.push(el.value);
                        selectedUsernames.push(el.getAttribute('data-username'));
                    });
                    config.SelectedUserIds = selectedUserIds;
                    config.SelectedUsernames = selectedUsernames;

                    var selectedLibIds = [];
                    var selectedLibPaths = [];
                    document.querySelectorAll('#LibrariesList input[type="checkbox"][data-kind="library"]:checked').forEach(function (el) {
                        selectedLibIds.push(el.value);
                        try {
                            var paths = JSON.parse(decodeURIComponent(el.getAttribute('data-paths') || '[]'));
                            (paths || []).forEach(function (p) { selectedLibPaths.push(p); });
                        } catch {}
                    });
                    config.SelectedLibraryIds = selectedLibIds;
                    config.SelectedLibraryPaths = selectedLibPaths;
                    config.VerifyDirectory = document.querySelector('#VerifyDirectory') ? document.querySelector('#VerifyDirectory').value : '';
                    return ApiClient.updatePluginConfiguration(TemplateConfig.pluginUniqueId, config);
                }).then(function (result) {
                    console.log('Configuration saved:', result);
                    return new Promise(function(resolve) { setTimeout(function() { resolve(); }, 1000); });
                }).then(function () {
                    return ApiClient.getScheduledTasks();
                }).then(function (tasks) {
                    var task = (tasks || []).find(function (t) { return t.Key === 'JellyfinMigratorExport'; });
                    if (!task) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert({ title: 'Migrator', message: 'Migration task not found.' });
                        return Promise.reject('Task not found');
                    }
                    return ApiClient.startScheduledTask(task.Id).then(function () { return task; });
                }).then(function () {
                    Dashboard.hideLoadingMsg();
                    $status.textContent = 'RUNNING.';
                    var started = Date.now();
                    var poll = function () {
                        ApiClient.getScheduledTasks().then(function (tasks) {
                            var t = (tasks || []).find(function (x) { return x.Key === 'JellyfinMigratorExport'; });
                            if (!t) { return; }
                            var state = (t.State || t.Status || '').toString().toLowerCase();
                            if (state.indexOf('running') !== -1) {
                                $status.textContent = 'RUNNING.';
                            } else if (state.indexOf('idle') !== -1 || state.indexOf('completed') !== -1 || state === '') {
                                $status.textContent = 'COMPLETED';
                                var $dl = document.getElementById('DownloadExportContainer');
                                if ($dl) { $dl.style.display = 'block'; }
                                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function(cfg){ downloadServerZipFromConfig(cfg); });
                                return;
                            }
                            if (Date.now() - started < 5 * 60 * 1000) { setTimeout(poll, 2000); }
                        }).catch(function () {
                            if (Date.now() - started < 5 * 60 * 1000) { setTimeout(poll, 4000); }
                        });
                    };
                    setTimeout(poll, 1500);
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    console.error('Failed to save settings or start export', err);
                    Dashboard.alert({ title: 'Migrator', message: 'Failed to save settings or start export.' });
                });
            });

            // ===== LIVE LOG UPDATER =====
            (function setupLiveLogUpdater() {
                var timerId = null;
                function updateLog() {
                    ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (cfg) {
                        try { renderExportLog(cfg); } catch (e) {}
                    });
                }
                function checkStatus() {
                    var $status = document.querySelector('#ExportRunStatus');
                    var s = ($status && $status.textContent || '').toLowerCase();
                    if (s.indexOf('running') !== -1) {
                        if (!timerId) { timerId = setInterval(updateLog, 2000); }
                    } else {
                        if (timerId) { clearInterval(timerId); timerId = null; updateLog(); }
                    }
                }
                setInterval(checkStatus, 1000);
            })();

            // ===== TAB MANAGEMENT =====
            (function setupTabs() {
                var $tabExport = document.getElementById('TabExport');
                var $tabImport = document.getElementById('TabImport');
                var $export = document.getElementById('ExportTab');
                var $import = document.getElementById('ImportTab');
                var $runText = document.getElementById('RunButtonText');

                function setActive(tab) {
                    if ($export) { $export.style.display = tab === 'Export' ? 'block' : 'none'; }
                    if ($import) { $import.style.display = tab === 'Import' ? 'block' : 'none'; }
                    [$tabExport,$tabImport].filter(Boolean).forEach(function(btn){
                        btn.classList.remove('raised');
                        if (!btn.classList.contains('button-flat')) btn.classList.add('button-flat');
                    });
                    if (tab === 'Export' && $tabExport) { $tabExport.classList.add('raised'); }
                    if (tab === 'Import' && $tabImport) { $tabImport.classList.add('raised'); }
                    if ($runText) { $runText.textContent = tab === 'Import' ? 'Save Config' : 'Save & Run Export'; }
                    if (tab === 'Import') {
                        var hold = document.getElementById('ImportHolding'); if (hold) hold.style.display = 'none';
                        var dirEl = document.getElementById('ImportDirectory');
                        if (dirEl && dirEl.closest) {
                            var ctn = dirEl.closest('.inputContainer'); if (ctn) { ctn.style.display = 'none'; }
                        }
                        var bid = document.getElementById('BrowseImportDir'); if (bid) { bid.style.display = 'none'; }
                    }
                }

                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function(cfg){
                    var desired = (cfg.Mode || 'Export');
                    setActive(desired);
                });

                if ($tabExport) $tabExport.addEventListener('click', function(){ setActive('Export'); });
                if ($tabImport) $tabImport.addEventListener('click', function(){ setActive('Import'); });
            })();

            // ===== IMPORT ZIP UPLOAD =====
            (function setupImport() {
                var uploadBtn = document.getElementById('UploadImportZip');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', function(){
                        var fileInput = document.getElementById('ImportZipFile');
                        var statusEl = document.getElementById('ImportAnalyzeStatus');
                        var breakdownEl = document.getElementById('ImportBreakdown');
                        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                            Dashboard.alert({ title: 'Import', message: 'Please choose a ZIP file first.' });
                            return;
                        }
                        var file = fileInput.files[0];
                        statusEl.style.display = 'block';
                        statusEl.textContent = 'Uploading and analyzing...';
                        breakdownEl.style.display = 'none';
                        breakdownEl.innerHTML = '';

                        var reader = new FileReader();
                        reader.onload = function(){
                            try {
                                var arr = new Uint8Array(reader.result);
                                var b64 = btoa(Array.prototype.map.call(arr, function(ch){ return String.fromCharCode(ch); }).join(''));
                                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function(cfg){
                                    cfg.LastImportZipBase64 = b64;
                                    cfg.Mode = 'Import';
                                    return ApiClient.updatePluginConfiguration(TemplateConfig.pluginUniqueId, cfg);
                                }).then(function(){
                                    return ApiClient.getScheduledTasks();
                                }).then(function(tasks){
                                    var t = tasks.find(function(x){ return x && (x.Key === 'JellyfinMigratorExport' || x.Name === 'Migration: Export Data'); });
                                    if (!t) throw new Error('Import task not found');
                                    return ApiClient.startScheduledTask(t.Id).then(function(){ return t; });
                                }).then(function(){
                                    var attempts = 0; var maxAttempts = 40;
                                    function poll(){
                                        attempts++;
                                        ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function(cfg){
                                            if (cfg && cfg.LastImportAnalysisJson){
                                                var data = {};
                                                try { data = JSON.parse(cfg.LastImportAnalysisJson); } catch(e) { console.warn('Bad analysis JSON', e); }
                                                statusEl.textContent = 'Analysis complete.';
                                                renderImportBreakdown(data);
                                            } else if (attempts < maxAttempts) {
                                                setTimeout(poll, 1000);
                                            } else {
                                                statusEl.textContent = 'Timed out waiting for analysis.';
                                            }
                                        });
                                    }
                                    setTimeout(poll, 1000);
                                }).catch(function(err){
                                    console.error('Import analyze failed', err);
                                    statusEl.textContent = 'Import failed.';
                                    Dashboard.alert({ title: 'Import', message: 'Upload/analyze failed. See console.' });
                                });
                            } catch (e) {
                                console.error('Failed to encode file', e);
                                statusEl.textContent = 'Import failed.';
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                }

                var serverZipBtn = document.getElementById('DownloadServerZipBtn');
                if (serverZipBtn) serverZipBtn.addEventListener('click', function(){
                    ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(downloadServerZipFromConfig);
                });

                // Run Import Now button
                var runImportBtn = document.getElementById('RunImportNow');
                if (runImportBtn) runImportBtn.addEventListener('click', function(){
                    runImportNow();
                });
            })();

            // ===== IMPORT EXECUTION =====
            function runImportNow() {
                // Show warning dialog first
                var warningMessage =
                    '⚠️ IMPORTANT: Library scanning can take several minutes per library.\n\n' +
                    'Large libraries may take 10-30+ minutes to fully scan.\n\n' +
                    'Please do NOT close this window or navigate away during the import.\n\n' +
                    'Progress will be logged in real-time below.\n\n' +
                    'Click OK to proceed with the import, or Cancel to abort.';

                if (confirm(warningMessage)) {
                    // User confirmed, proceed with import
                    executeImport();
                } else {
                    // User cancelled
                    console.log('User cancelled import');
                }
            }

            function executeImport() {
                Dashboard.showLoadingMsg();
                var $status = document.querySelector('#ImportRunStatus');
                var $log = document.querySelector('#ImportLog');

                if ($status) $status.textContent = 'Preparing import...';
                if ($log) $log.textContent = '';

                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (config) {
                    // Collect selected libraries
                    var selectedLibIds = [];
                    document.querySelectorAll('input[data-kind="import-library"]:checked').forEach(function (el) {
                        selectedLibIds.push(el.value);
                    });

                    if (selectedLibIds.length === 0) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert({ title: 'Import', message: 'Please select at least one library to import.' });
                        return Promise.reject('No libraries selected');
                    }

                    // Collect path mappings
                    var pathMappings = {};
                    selectedLibIds.forEach(function(libId) {
                        var paths = [];
                        document.querySelectorAll('.import-lib-path[data-lib-id="' + libId + '"]').forEach(function(input) {
                            var path = input.value.trim();
                            if (path) paths.push(path);
                        });
                        if (paths.length > 0) {
                            pathMappings[libId] = paths;
                        }
                    });

                    // Update config
                    config.Mode = 'Import';
                    // Import toggles
                    config.ImportIncludeUsers = document.querySelector('#ImportIncludeUsers')?.checked || false;
                    config.ImportIncludeLibraries = document.querySelector('#ImportIncludeLibraries')?.checked || false;
                    config.ImportSelectedLibraryIds = selectedLibIds;
                    config.ImportLibraryPathMappingsJson = JSON.stringify(pathMappings);

                    return ApiClient.updatePluginConfiguration(TemplateConfig.pluginUniqueId, config);
                }).then(function () {
                    return new Promise(function(resolve) { setTimeout(function() { resolve(); }, 1000); });
                }).then(function () {
                    return ApiClient.getScheduledTasks();
                }).then(function (tasks) {
                    var task = (tasks || []).find(function (t) { return t.Key === 'JellyfinMigratorExport'; });
                    if (!task) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert({ title: 'Import', message: 'Import task not found.' });
                        return Promise.reject('Task not found');
                    }
                    return ApiClient.startScheduledTask(task.Id).then(function () { return task; });
                }).then(function () {
                    Dashboard.hideLoadingMsg();
                    $status.textContent = 'RUNNING...';
                    var started = Date.now();
                    var poll = function () {
                        ApiClient.getScheduledTasks().then(function (tasks) {
                            var t = (tasks || []).find(function (x) { return x.Key === 'JellyfinMigratorExport'; });
                            if (!t) { return; }
                            var state = (t.State || t.Status || '').toString().toLowerCase();
                            if (state.indexOf('running') !== -1) {
                                $status.textContent = 'RUNNING...';
                            } else if (state.indexOf('idle') !== -1 || state.indexOf('completed') !== -1 || state === '') {
                                $status.textContent = 'COMPLETED';
                                renderImportLog();
                                return;
                            }
                            if (Date.now() - started < 10 * 60 * 1000) { setTimeout(poll, 2000); }
                        }).catch(function () {
                            if (Date.now() - started < 10 * 60 * 1000) { setTimeout(poll, 4000); }
                        });
                    };
                    setTimeout(poll, 1500);
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    console.error('Failed to start import', err);
                    if (err !== 'Task not found' && err !== 'No libraries selected') {
                        Dashboard.alert({ title: 'Import', message: 'Failed to start import.' });
                    }
                });
            }

            function renderImportLog() {
                var $log = document.querySelector('#ImportLog');
                var $meta = document.querySelector('#ImportMeta');
                if (!$log || !$meta) { return; }

                ApiClient.getPluginConfiguration(TemplateConfig.pluginUniqueId).then(function (cfg) {
                    var log = (cfg.LastImportLog || cfg.LastExportLog || '').toString();
                    $log.textContent = log.trim() ? log : '(no import log available)';
                    var parts = [];
                    if (cfg.LastImportUtc) {
                        try { parts.push('Completed: ' + new Date(cfg.LastImportUtc).toLocaleString()); } catch(e) {}
                    }
                    if (cfg.LastImportExtractPath) {
                        parts.push('Path: ' + cfg.LastImportExtractPath);
                    }
                    $meta.textContent = parts.join(' | ');
                });
            }

            // Live log updater for import
            (function setupImportLiveLogUpdater() {
                var timerId = null;
                function updateLog() {
                    renderImportLog();
                }
                function checkStatus() {
                    var $status = document.querySelector('#ImportRunStatus');
                    var s = ($status && $status.textContent || '').toLowerCase();
                    if (s.indexOf('running') !== -1) {
                        if (!timerId) { timerId = setInterval(updateLog, 2000); }
                    } else {
                        if (timerId) { clearInterval(timerId); timerId = null; updateLog(); }
                    }
                }
                setInterval(checkStatus, 1000);
            })();
        </script>
    </div>
</body>
</html>
